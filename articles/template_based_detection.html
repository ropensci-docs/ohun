<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Template-based detection • ohun</title>
<!-- rOpenSci favicons --><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Template-based detection">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@v3.0.0/dist/cookieconsent.css">
<script src="https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@v3.0.0/dist/cookieconsent.umd.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><p><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">
    <a href="https://ropensci.org" class="external-link"><img src="https://ropensci.org/img/icon_short_white.svg" id="hexlogo" alt="rOpenSci"></a>
    <a class="navbar-brand me-2" href="../index.html">ohun</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.0.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"></ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/energy_based_detection.html">Energy-based detection</a></li>
    <li><a class="dropdown-item" href="../articles/intro_to_ohun.html">Optimizing sound event detection</a></li>
    <li><a class="dropdown-item" href="../articles/template_based_detection.html">Template-based detection</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ropensci/ohun/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Template-based detection</h1>
                        <h4 data-toc-skip class="author"><a href="https://marce10.github.io/" class="external-link">Marcelo
Araya-Salas, PhD</a></h4>
            
            <h4 data-toc-skip class="date">2024-10-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/ohun/blob/master/vignettes/template_based_detection.Rmd" class="external-link"><code>vignettes/template_based_detection.Rmd</code></a></small>
      <div class="d-none name"><code>template_based_detection.Rmd</code></div>
    </div>

    
    
<p>This vignette details the use of template-based detection in <a href="https://github.com/ropensci/ohun" class="external-link">ohun</a>.Template-based
detection method is better suited for highly stereotyped sound events.
As it is less affected by signal-to-noise ratio it’s more robust to
higher levels of background noise:</p>
<figure><center>
<img src="analysis_workflow_template.png" alt="automated signal detection diagram" width="500" height="450">
</center>
<figcaption><i>Diagram depicting how target sound event features can be used to tell
the most adequate sound event detection approach. Steps in which ‘ohun’
can be helpful are shown in color. (SNR = signal-to-noise ratio) </i>
</figcaption></figure><p>The procedure for template-based detection is divided in three
steps:</p>
<ul>
<li>Choosing the right template (<code><a href="../reference/get_templates.html">get_templates()</a></code>)</li>
<li>Estimating the cross-correlation scores of templates along sound
files (<code><a href="../reference/template_correlator.html">template_correlator()</a></code>)<br>
</li>
<li>Detecting sound events by applying a correlation threshold
(<code><a href="../reference/template_detector.html">template_detector()</a></code>)</li>
</ul>
<p>First, we need to install the package. It can be installed from CRAN
as follows:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># From CRAN would be</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"ohun"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#load package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/ohun/">ohun</a></span><span class="op">)</span></span></code></pre></div>
<p>To install the latest developmental version from <a href="https://github.com/" class="external-link">github</a> you will need the R package <a href="https://cran.r-project.org/package=devtools" class="external-link">remotes</a>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install package</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"maRce10/ohun"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/ohun/">ohun</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tuner.R-forge.R-project.org" class="external-link">tuneR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://marce10.github.io/warbleR/" class="external-link">warbleR</a></span><span class="op">)</span></span></code></pre></div>
<p>The package comes with an example reference table containing
annotations of long-billed hermit hummingbird songs from two sound files
(also supplied as example data: ‘lbh1’ and ‘lbh2’), which will be used
in this vignette. The example data can be load and explored as
follows:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load example data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"lbh1"</span>, <span class="st">"lbh2"</span>, <span class="st">"lbh_reference"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># save sound files</span></span>
<span><span class="fu">tuneR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tuneR/man/writeWave.html" class="external-link">writeWave</a></span><span class="op">(</span><span class="va">lbh1</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"lbh1.wav"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">tuneR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/tuneR/man/writeWave.html" class="external-link">writeWave</a></span><span class="op">(</span><span class="va">lbh2</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"lbh2.wav"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># select a subset of the data</span></span>
<span><span class="va">lbh1_reference</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">lbh_reference</span><span class="op">[</span><span class="va">lbh_reference</span><span class="op">$</span><span class="va">sound.files</span> <span class="op">==</span> <span class="st">"lbh1.wav"</span>,<span class="op">]</span></span>
<span></span>
<span><span class="co"># print data</span></span>
<span><span class="va">lbh1_reference</span></span></code></pre></div>
<pre><code> [30mObject of class  [1m'selection_table' [22m [39m</code></pre>
<pre><code> [90m* The output of the following call: [39m</code></pre>
<pre><code> [90m [3m`[.selection_table`(X = lbh_reference, i = lbh_reference$sound.files ==  [23m [39m [90m [3m"lbh1.wav") [23m [39m</code></pre>
<pre><code> [90m [1m
Contains: [22m 
*  A selection table data frame with 10 rows and 6 columns: [39m</code></pre>
<pre><code> [90m|   |sound.files | selec|  start|    end| bottom.freq| top.freq| [39m</code></pre>
<pre><code> [90m|:--|:-----------|-----:|------:|------:|-----------:|--------:| [39m</code></pre>
<pre><code> [90m|10 |lbh1.wav    |    10| 0.0881| 0.2360|      1.9824|   8.4861| [39m</code></pre>
<pre><code> [90m|11 |lbh1.wav    |    11| 0.5723| 0.7202|      2.0520|   9.5295| [39m</code></pre>
<pre><code> [90m|12 |lbh1.wav    |    12| 1.0564| 1.1973|      2.0868|   8.4861| [39m</code></pre>
<pre><code> [90m|13 |lbh1.wav    |    13| 1.7113| 1.8680|      1.9824|   8.5905| [39m</code></pre>
<pre><code> [90m|14 |lbh1.wav    |    14| 2.1902| 2.3417|      2.0520|   8.5209| [39m</code></pre>
<pre><code> [90m|15 |lbh1.wav    |    15| 2.6971| 2.8538|      1.9824|   9.2513| [39m</code></pre>
<pre><code> [90m... and 4 more row(s) [39m</code></pre>
<pre><code> [90m
* A data frame (check.results) with 10 rows generated by check_sels() (as attribute) [39m</code></pre>
<pre><code> [90mcreated by warbleR &lt; 1.1.21 [39m</code></pre>
<p>We can also plot the annotations on top of the spectrograms to
further explore the data (this function only plots one wave object at
the time, not really useful for long files):</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># print spectrogram</span></span>
<span><span class="fu"><a href="../reference/label_spectro.html">label_spectro</a></span><span class="op">(</span>wave <span class="op">=</span> <span class="va">lbh1</span>, reference <span class="op">=</span> <span class="va">lbh1_reference</span>, hop.size <span class="op">=</span> <span class="fl">10</span>, ovlp <span class="op">=</span> <span class="fl">50</span>, flim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="template_based_detection_files/figure-html/unnamed-chunk-4-1.png" width="100%" style="display: block; margin: auto;"></p>
<hr>
<p>The function <code><a href="../reference/get_templates.html">get_templates()</a></code> can help you find a
template closer to the average acoustic structure of the sound events in
a reference table. This is done by finding the sound events closer to
the centroid of the acoustic space. When the acoustic space is not
supplied (‘acoustic.space’ argument) the function estimates it by
measuring several acoustic parameters using the function <a href="https://marce10.github.io/warbleR/reference/spectro_analysis.html" class="external-link"><code>spectro_analysis()</code></a>
from <a href="https://CRAN.R-project.org/package=warbleR" class="external-link"><code>warbleR</code></a>)
and summarizing it with Principal Component Analysis (after
z-transforming parameters). If only 1 template is required the function
returns the sound event closest to the acoustic space centroid. The
rationale here is that a sound event closest to the average sound event
structure is more likely to share structural features with most sounds
across the acoustic space than a sound event in the periphery of the
space. These ‘mean structure’ templates can be obtained as follows:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get mean structure template</span></span>
<span><span class="va">template</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/get_templates.html">get_templates</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">lbh1_reference</span>, path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code> [30mcomputing spectral features (step 0 of 0): [39m</code></pre>
<pre><code> [90mThe first 2 principal components explained 0.53 of the variance [39m</code></pre>
<p><img src="template_based_detection_files/figure-html/unnamed-chunk-6-1.png" width="80%" style="display: block; margin: auto;"></p>
<p>The graph above shows the overall acoustic spaces, in which the sound
closest to the space centroid is highlighted. The highlighted sound is
selected as the template and can be used to detect similar sound events.
The function <code><a href="../reference/get_templates.html">get_templates()</a></code> can also select several
templates. This can be helpful when working with sounds that are just
moderately stereotyped. This is done by dividing the acoustic space into
sub-spaces defined as equal-size slices of a circle centered at the
centroid of the acoustic space:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get 3 templates</span></span>
<span><span class="fu"><a href="../reference/get_templates.html">get_templates</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">lbh1_reference</span>, </span>
<span>                          n.sub.spaces <span class="op">=</span> <span class="fl">3</span>, path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code> [90mThe first 2 principal components explained 0.53 of the variance [39m</code></pre>
<pre><code> [90m1 sub-space centroid(s) coincide with the overall centroid and was (were) removed [39m</code></pre>
<p><img src="template_based_detection_files/figure-html/unnamed-chunk-8-1.png" width="80%" style="display: block; margin: auto;"></p>
<p>We will use the single template object (‘template’) to run a
detection on the example ‘lbh1’ data:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get correlations</span></span>
<span><span class="va">correlations</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/template_correlator.html">template_correlator</a></span><span class="op">(</span>templates <span class="op">=</span> <span class="va">template</span>,</span>
<span>                      files <span class="op">=</span> <span class="st">"lbh1.wav"</span>,</span>
<span>                      path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The output is an object of class ‘template_correlations’, with its
own printing method:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># print</span></span>
<span><span class="va">correlations</span></span></code></pre></div>
<pre><code> [30mObject of class  [1m'template_correlations' 
 [22m [39m</code></pre>
<pre><code> [90m* The output of the following  [3mtemplate_correlator() [23m call: 
 [39m</code></pre>
<pre><code> [90m [3mtemplate_correlator(templates = template, files = "lbh1.wav", 
 [23m [39m [90m [3mpath = tempdir())
 [23m [39m</code></pre>
<pre><code> [90m* Contains 1 correlation score vector(s) from 1 template(s):
  [3mlbh1.wav-19 [23m  [39m</code></pre>
<pre><code> [90m
... and 1 sound files(s):
  [3mlbh1.wav [23m  [39m</code></pre>
<pre><code> [90m
 * Created by  [1mohun  [22m1.0.2 [39m</code></pre>
<p>This object can then be used to detect sound events using
<code><a href="../reference/template_detector.html">template_detector()</a></code>:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run detection</span></span>
<span><span class="va">detection</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/template_detector.html">template_detector</a></span><span class="op">(</span>template.correlations <span class="op">=</span> <span class="va">correlations</span>, threshold <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span></span>
<span><span class="va">detection</span></span></code></pre></div>
<pre><code> [30mObject of class  [1m'selection_table' [22m [39m</code></pre>
<pre><code> [90m* The output of the following call: [39m</code></pre>
<pre><code> [90m [3mtemplate_detector(template.correlations = correlations, threshold = 0.7) [23m [39m</code></pre>
<pre><code> [90m [1m
Contains: [22m 
*  A selection table data frame with 2 rows and 6 columns: [39m</code></pre>
<pre><code> [90m|sound.files | selec|  start|    end|template    | scores| [39m</code></pre>
<pre><code> [90m|:-----------|-----:|------:|------:|:-----------|------:| [39m</code></pre>
<pre><code> [90m|lbh1.wav    |     1| 0.5703| 0.7287|lbh1.wav-19 | 0.7122| [39m</code></pre>
<pre><code> [90m|lbh1.wav    |     2| 4.1549| 4.3133|lbh1.wav-19 | 0.7189| [39m</code></pre>
<pre><code> [90m
* A data frame (check.results) with 2 rows generated by check_sels() (as attribute) [39m</code></pre>
<pre><code> [90mcreated by warbleR 1.1.32 [39m</code></pre>
<p>The output can be explored by plotting the spectrogram along with the
detection and correlation scores:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot spectrogram</span></span>
<span><span class="fu"><a href="../reference/label_spectro.html">label_spectro</a></span><span class="op">(</span></span>
<span>  wave <span class="op">=</span> <span class="va">lbh1</span>,</span>
<span>  detection <span class="op">=</span> <span class="va">detection</span>,</span>
<span>  template.correlation <span class="op">=</span> <span class="va">correlations</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  flim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  threshold <span class="op">=</span> <span class="fl">0.7</span>,</span>
<span>  hop.size <span class="op">=</span> <span class="fl">10</span>, ovlp <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<p><img src="template_based_detection_files/figure-html/unnamed-chunk-12-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>The performance can be evaluated using
<code><a href="../reference/diagnose_detection.html">diagnose_detection()</a></code>:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#diagnose</span></span>
<span><span class="fu"><a href="../reference/diagnose_detection.html">diagnose_detection</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">lbh1_reference</span>, detection <span class="op">=</span> <span class="va">detection</span><span class="op">)</span></span></code></pre></div>
<pre><code>  detections true.positives false.positives false.negatives splits merges   overlap
1          2              2               0               8      0      0 0.9004082
  recall precision   f.score
1    0.2         1 0.3333333</code></pre>
<div class="section level2">
<h2 id="optimizing-template-based-detection">Optimizing template-based detection<a class="anchor" aria-label="anchor" href="#optimizing-template-based-detection"></a>
</h2>
<p>The function <code><a href="../reference/optimize_template_detector.html">optimize_template_detector()</a></code> allows to
evaluate the performance under different correlation thresholds:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run optimization</span></span>
<span><span class="va">optimization</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/optimize_template_detector.html">optimize_template_detector</a></span><span class="op">(</span></span>
<span>    template.correlations <span class="op">=</span> <span class="va">correlations</span>,</span>
<span>    reference <span class="op">=</span> <span class="va">lbh1_reference</span>,</span>
<span>    threshold <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<pre><code>5 thresholds will be evaluated:</code></pre>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># print output</span></span>
<span><span class="va">optimization</span></span></code></pre></div>
<pre><code>  threshold   templates detections true.positives false.positives false.negatives splits
1       0.1 lbh1.wav-19         99             10              89               0     16
2       0.2 lbh1.wav-19         56             10              46               0     16
3       0.3 lbh1.wav-19         25             10              15               0     13
4       0.4 lbh1.wav-19         11             10               1               0      2
5       0.5 lbh1.wav-19         10             10               0               0      0
  merges   overlap recall precision   f.score
1      0 0.8789903      1 0.1010101 0.1834862
2      0 0.8789903      1 0.1785714 0.3030303
3      0 0.8789903      1 0.4000000 0.5714286
4      0 0.8789903      1 0.9090909 0.9523810
5      0 0.8789903      1 1.0000000 1.0000000</code></pre>
<p>Additional threshold values can be evaluated without having to run it
all over again. We just need to supplied the output from the previous
run with the argument <code>previous.output</code> (the same trick can
be done when optimizing an energy-based detection):</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># run optimization</span></span>
<span><span class="fu"><a href="../reference/optimize_template_detector.html">optimize_template_detector</a></span><span class="op">(</span></span>
<span>  template.correlations <span class="op">=</span> <span class="va">correlations</span>,</span>
<span>  reference <span class="op">=</span> <span class="va">lbh1_reference</span>,</span>
<span>  threshold <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">0.7</span><span class="op">)</span>,</span>
<span>  previous.output <span class="op">=</span> <span class="va">optimization</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>2 thresholds will be evaluated:</code></pre>
<pre><code>  threshold   templates detections true.positives false.positives false.negatives splits
1       0.1 lbh1.wav-19         99             10              89               0     16
2       0.2 lbh1.wav-19         56             10              46               0     16
3       0.3 lbh1.wav-19         25             10              15               0     13
4       0.4 lbh1.wav-19         11             10               1               0      2
5       0.5 lbh1.wav-19         10             10               0               0      0
6       0.6 lbh1.wav-19         10             10               0               0      0
7       0.7 lbh1.wav-19          2              2               0               8      0
  merges   overlap recall precision   f.score
1      0 0.8789903    1.0 0.1010101 0.1834862
2      0 0.8789903    1.0 0.1785714 0.3030303
3      0 0.8789903    1.0 0.4000000 0.5714286
4      0 0.8789903    1.0 0.9090909 0.9523810
5      0 0.8789903    1.0 1.0000000 1.0000000
6      0 0.8789903    1.0 1.0000000 1.0000000
7      0 0.9004082    0.2 1.0000000 0.3333333</code></pre>
<p>In this case 2 threshold values (0.5 and 0.6) can achieve an optimal
detection.</p>
</div>
<div class="section level2">
<h2 id="detecting-several-templates">Detecting several templates<a class="anchor" aria-label="anchor" href="#detecting-several-templates"></a>
</h2>
<p>Several templates can be used within the same call. Here we correlate
two templates on the two example sound files, taking one template from
each sound file:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get correlations</span></span>
<span><span class="va">correlations</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/template_correlator.html">template_correlator</a></span><span class="op">(</span></span>
<span>    templates <span class="op">=</span> <span class="va">lbh1_reference</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>,<span class="op">]</span>,</span>
<span>    files <span class="op">=</span> <span class="st">"lbh1.wav"</span>,</span>
<span>    path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># run detection</span></span>
<span><span class="va">detection</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/template_detector.html">template_detector</a></span><span class="op">(</span>template.correlations <span class="op">=</span> <span class="va">correlations</span>, threshold <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span></code></pre></div>
<p>Note that in these cases we can get the same sound event detected
several times (duplicates), one by each template. We can check if that
is the case just by diagnosing the detection:</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#diagnose</span></span>
<span><span class="fu"><a href="../reference/diagnose_detection.html">diagnose_detection</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">lbh1_reference</span>, detection <span class="op">=</span> <span class="va">detection</span><span class="op">)</span></span></code></pre></div>
<pre><code>  detections true.positives false.positives false.negatives splits merges   overlap
1         20             10              10               0     20      0 0.9306396
  recall precision   f.score
1      1       0.5 0.6666667</code></pre>
<p>In this we got perfect recall, but low precision. That is due to the
fact that the same reference events were picked up by both templates. We
can actually diagnose the detection by template to see this more
clearly:</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#diagnose</span></span>
<span><span class="fu"><a href="../reference/diagnose_detection.html">diagnose_detection</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">lbh1_reference</span>, detection <span class="op">=</span> <span class="va">detection</span>, by <span class="op">=</span> <span class="st">"template"</span><span class="op">)</span></span></code></pre></div>
<pre><code>     template detections true.positives false.positives false.negatives splits merges
1 lbh1.wav-10         10             10               0               0      0      0
2 lbh1.wav-19         10             10               0               0      0      0
    overlap recall precision f.score
1 0.9241771      1         1       1
2 0.8789903      1         1       1</code></pre>
<p>We see that independently each template achieved a good detection. We
can create a consensus detection by leaving only those with detections
with the highest correlation across templates. To do this we first need
to label each row in the detection using <code><a href="../reference/label_detection.html">label_detection()</a></code>
and then remove duplicates using <code><a href="../reference/consensus_detection.html">consensus_detection()</a></code>:</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># labeling detection</span></span>
<span><span class="va">labeled</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/label_detection.html">label_detection</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">lbh_reference</span>, detection <span class="op">=</span> <span class="va">detection</span>, by <span class="op">=</span> <span class="st">"template"</span><span class="op">)</span></span></code></pre></div>
<p>Now we can filter out duplicates and diagnose the detection again,
telling the function to select a single row per duplicate using the
correlation score as a criterium (<code>by = "scores"</code>, this
column is part of the <code><a href="../reference/template_detector.html">template_detector()</a></code> output):</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># filter</span></span>
<span><span class="va">consensus</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/consensus_detection.html">consensus_detection</a></span><span class="op">(</span>detection <span class="op">=</span> <span class="va">labeled</span>, by <span class="op">=</span> <span class="st">"scores"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># diagnose</span></span>
<span><span class="fu"><a href="../reference/diagnose_detection.html">diagnose_detection</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">lbh1_reference</span>, detection <span class="op">=</span> <span class="va">consensus</span><span class="op">)</span></span></code></pre></div>
<pre><code>  detections true.positives false.positives false.negatives splits merges   overlap
1         10             10               0               0      0      0 0.9046387
  recall precision f.score
1      1         1       1</code></pre>
<p>We successfully get rid of duplicates and detected every single
target sound event.</p>
<hr>
<div class="alert alert-info">
<p>Please cite <a href="https://github.com/ropensci/ohun" class="external-link">ohun</a> like
this:</p>
<p>Araya-Salas, M. (2021), <em>ohun: diagnosing and optimizing automated
sound event detection</em>. R package version 0.1.0.</p>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ol style="list-style-type: decimal">
<li>Araya-Salas, M. (2021), ohun: diagnosing and optimizing automated
sound event detection. R package version 0.1.0.</li>
<li>Araya-Salas M, Smith-Vidaurre G (2017) warbleR: An R package to
streamline analysis of animal sound events. Methods Ecol Evol
8:184-191.</li>
<li>Khanna H., Gaunt S.L.L. &amp; McCallum D.A. (1997). Digital
spectrographic cross-correlation: tests of sensitivity. Bioacoustics
7(3): 209-234.</li>
<li>Knight, E.C., Hannah, K.C., Foley, G.J., Scott, C.D., Brigham, R.M.
&amp; Bayne, E. (2017). Recommendations for acoustic recognizer
performance assessment with application to five common automated signal
recognition programs. Avian Conservation and Ecology,</li>
<li>Macmillan, N. A., &amp; Creelman, C.D. (2004). Detection theory: A
user’s guide. Psychology press.</li>
</ol>
<hr>
<p><font size="4">Session information</font></p>
<pre><code>R version 4.4.1 (2024-06-14)
Platform: x86_64-pc-linux-gnu
Running under: Ubuntu 24.04.1 LTS

Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 
LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C               LC_TIME=en_US.UTF-8       
 [4] LC_COLLATE=en_US.UTF-8     LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                  LC_ADDRESS=C              
[10] LC_TELEPHONE=C             LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

time zone: Etc/UTC
tzcode source: system (glibc)

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] warbleR_1.1.32     NatureSounds_1.0.4 knitr_1.48         seewave_2.2.3     
[5] tuneR_1.4.7        ohun_1.0.2        

loaded via a namespace (and not attached):
 [1] gtable_0.3.5        rjson_0.2.23        xfun_0.48           bslib_0.8.0        
 [5] ggplot2_3.5.1       vctrs_0.6.5         tools_4.4.1         bitops_1.0-9       
 [9] parallel_4.4.1      tibble_3.2.1        proxy_0.4-27        fansi_1.0.6        
[13] highr_0.11          pkgconfig_2.0.3     KernSmooth_2.23-24  checkmate_2.3.2    
[17] desc_1.4.3          lifecycle_1.0.4     compiler_4.4.1      textshaping_0.4.0  
[21] brio_1.1.5          munsell_0.5.1       htmltools_0.5.8.1   class_7.3-22       
[25] sass_0.4.9          RCurl_1.98-1.16     yaml_2.3.10         pillar_1.9.0       
[29] pkgdown_2.1.0       jquerylib_0.1.4     MASS_7.3-61         classInt_0.4-10    
[33] cachem_1.1.0        viridis_0.6.5       digest_0.6.37       sf_1.0-18          
[37] fastmap_1.2.0       grid_4.4.1          colorspace_2.1-1    cli_3.6.3          
[41] magrittr_2.0.3      utf8_1.2.4          e1071_1.7-16        scales_1.3.0       
[45] backports_1.5.0     rmarkdown_2.28      signal_1.8-1        igraph_2.1.1       
[49] gridExtra_2.3       ragg_1.3.2          pbapply_1.7-2       evaluate_1.0.1.9000
[53] dtw_1.23-1          fftw_1.0-9          testthat_3.2.1.1    viridisLite_0.4.2  
[57] rlang_1.1.4         Rcpp_1.0.13         glue_1.8.0          DBI_1.2.3          
[61] jsonlite_1.8.9      R6_2.5.1            systemfonts_1.1.0   fs_1.6.4           
[65] units_0.8-5        </code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start top-4 bottom-8">
            <div class="col-2"> <img id="footerlogo" src="https://ropensci.org/img/icon_short_white.svg">
</div>
            <div class="col-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-github"></div></a>
                        <a href="https://github.com/ropenscilabs" target="_blank" class="external-link"><div class="icon fa fa-flask"></div></a>
                        <a href="https://hachyderm.io/@ropensci" target="_blank" class="external-link"><div class="icon fab fa-mastodon"></div></a>
                        <a href="https://vimeo.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-vimeo"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://ropensci.org/about" class="external-link">About rOpenSci</a></li>
                            <li><a href="https://ropensci.org/software-review" class="external-link">Software Review</a></li>
                            <li><a href="https://ropensci.org/about#team" class="external-link">Our Team</a></li>
                            <li><a href="https://ropensci.org/careers" class="external-link">Jobs</a></li>
                            <li><a href="https://ropensci.org/donate" class="external-link">Donate</a></li>
                            <li><a href="https://ropensci.org/contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-3 col-sm-4">
                        <ul>
<h5 class="bottom-2">Community</h5>
                            <li><a href="https://ropensci.org/community/" class="external-link">Our Community</a></li>
                            <li><a href="https://ropensci.org/commcalls/" class="external-link">Community calls</a></li>
                            <li><a href="https://ropensci.org/events/" class="external-link">Events</a></li>
                            <li><a href="https://discuss.ropensci.org/" class="external-link">Join the Discussion</a></li>
                            <li><a href="https://ropensci.org/code-of-conduct" class="external-link">Code of conduct</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://ropensci.org/packages/" class="external-link">Packages</a></li>
                            <li><a href="https://ropensci.org/usecases/" class="external-link">Use Cases</a></li>
                            <li><a href="https://ropensci.org/talks-papers/" class="external-link">Talks &amp; Publications</a></li>
                            <li><a href="https://docs.ropensci.org/" class="external-link">Documentation</a></li>
                            <li><a href="https://ropensci.org/news/" class="external-link">Newsletter</a></li>
                            <li><a href="https://ropensci.org/how-to-cite-ropensci/" class="external-link">Cite rOpenSci</a></li>
                        </ul>
</div>
                    <div class="col-md-4 col-xs-12">
                        <h5 class="bottom-2"></h5>

                        <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" class="external-link">NumFOCUS</a>.</p>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->


    </footer>
</div>





  </body>
</html>
